#!/usr/bin/env bash
set -euo pipefail

# Federation demo with 2-3 orgs (manager + echo + bravo optional).
# 1) Register each org's system_uri and roomID at the proxy
# 2) Run federated inquiry at the proxy
# 3) Run federated inquiry via service-side forwarder (Basic Auth)

PROXY_BASE="${PROXY_BASE:-http://localhost:8080}"
SERVICE_BASE="${SERVICE_BASE:-http://localhost:8012}"

MANAGER_URI="${MANAGER_URI:-manager}"
MANAGER_ROOM="${MANAGER_ROOM:-514}"
MANAGER_PORT="${MANAGER_PORT:-8010}"

ECHO_URI="${ECHO_URI:-echo}"
ECHO_ROOM="${ECHO_ROOM:-513}"
ECHO_PORT="${ECHO_PORT:-8011}"

BRAVO_URI="${BRAVO_URI:-bravo}"
BRAVO_ROOM="${BRAVO_ROOM:-515}"
BRAVO_PORT="${BRAVO_PORT:-8013}"

if ! command -v jq >/dev/null 2>&1; then
  echo "jq が必要です。brew install jq などでインストールしてください。" >&2
  exit 1
fi

if [[ -z "${PROXY_BASE}" || -z "${SERVICE_BASE}" ]]; then
  echo "PROXY_BASE / SERVICE_BASE を設定してください。" >&2
  exit 1
fi

pretty_json() {
  local body="$1"
  if ! echo "${body}" | jq .; then
    echo "--- raw response ---"
    echo "${body}"
    exit 1
  fi
}

# Basic auth for the service forwarder
BASIC_AUTH_USER="${BASIC_AUTH_USER:-user}"
BASIC_AUTH_PASS="${BASIC_AUTH_PASS:-PassWord@123}"

# Registration set: manager | manager+echo | manager+echo+bravo
# You can pass it as the first arg or via REGISTER_SET.
REGISTER_SET="${REGISTER_SET:-${1:-}}"

normalize_register_set() {
  case "$1" in
    1|manager)
      echo "manager"
      ;;
    2|manager+echo|manager-echo|manager_echo)
      echo "manager+echo"
      ;;
    3|manager+echo+bravo|manager-echo-bravo|manager_echo_bravo)
      echo "manager+echo+bravo"
      ;;
    *)
      return 1
      ;;
  esac
}

if [[ -n "${REGISTER_SET}" ]]; then
  if ! normalized_set="$(normalize_register_set "${REGISTER_SET}")"; then
    echo "REGISTER_SET は manager / manager+echo / manager+echo+bravo のいずれかを指定してください。" >&2
    exit 1
  fi
  REGISTER_SET="${normalized_set}"
elif [[ -t 0 ]]; then
  echo "登録する組織セットを選択してください:"
  echo "  1) manager only"
  echo "  2) manager + echo"
  echo "  3) manager + echo + bravo"
  read -r choice
  if ! normalized_set="$(normalize_register_set "${choice}")"; then
    echo "選択が不正です。1/2/3 を入力してください。" >&2
    exit 1
  fi
  REGISTER_SET="${normalized_set}"
else
  REGISTER_SET="manager+echo"
fi

# temp files for sample WiFi/BLE CSVs
wifi_csv="$(mktemp)"
ble_csv="$(mktemp)"
trap 'rm -f "$wifi_csv" "$ble_csv"' EXIT

now="$(date +%s)"
cat >"$wifi_csv" <<EOF
1755814738835 , 74:03:bd:ef:8a:00 , -76
1755814738835 , c8:a6:08:9a:fe:71 , -76
1755814738835 , c8:a6:08:9a:fc:90 , -94
1755814738835 , c8:a6:08:9a:fe:70 , -76
1755814738835 , c8:a6:08:9a:fc:91 , -94
1755814738835 , c4:36:c0:e3:cc:30 , -67
1755814738835 , c8:a6:08:9a:fc:94 , -95
1755814738835 , c8:a6:08:9a:fe:74 , -76
1755814738835 , 84:af:ec:86:f0:70 , -79
1755814738835 , c4:36:c0:e3:cc:36 , -67
1755814738835 , ac:44:f2:8c:e8:a8 , -80
1755814738835 , c4:36:c0:e3:cc:37 , -69
1755814738835 , c8:a6:08:9a:bb:c4 , -67
1755814738835 , c4:36:c0:e3:cc:38 , -78
1755814738835 , c8:a6:08:9a:bb:c1 , -67
1755814738835 , c8:a6:08:5a:fe:71 , -76
1755814738835 , c8:a6:08:5a:fe:70 , -76
1755814738835 , c8:a6:08:5a:bb:c1 , -66
1755814738835 , e8:4f:25:d3:9b:75 , -41
1755814738835 , c8:a6:08:9a:bb:c0 , -67
1755814738835 , c8:a6:08:5a:bb:c0 , -38
1755814738835 , c8:a6:08:9b:16:04 , -50
1755814738835 , 74:03:bd:ef:8a:10 , -85
1755814738835 , c8:a6:08:5b:16:04 , -52
1755814738835 , c8:a6:08:9b:16:01 , -50
1755814738835 , c8:a6:08:5b:16:01 , -52
1755814738835 , c8:a6:08:9b:16:00 , -50
1755814738835 , c8:a6:08:5b:16:00 , -52
1755814738835 , 3c:64:cf:5c:de:08 , -75
1755814738835 , c4:36:c0:e3:cc:3f , -77
1755814738835 , c8:a6:08:5a:bb:81 , -70
1755814738835 , c8:a6:08:9a:bc:10 , -61
1755814738835 , c8:a6:08:5a:bb:80 , -71
1755814738835 , c8:a6:08:9a:bc:11 , -61
1755814738835 , c8:a6:08:9a:bc:14 , -61
1755814738835 , c8:a6:08:9a:bb:80 , -75
1755814738835 , c8:a6:08:5a:bc:11 , -62
1755814738835 , c8:a6:08:9a:bb:81 , -75
1755814738835 , c8:a6:08:5a:bc:10 , -63
1755814738835 , ac:44:f2:8c:b0:e0 , -80
1755814738835 , c8:a6:08:9a:bb:84 , -75
1755814738835 , 60:84:bd:de:7c:67 , -74
1755814738835 , ac:44:f2:8c:e9:20 , -78
1755814738835 , c8:a6:08:5a:bb:84 , -71
1755814738835 , c0:25:a2:a7:2e:2b , -67
1755814738835 , c0:25:a2:a7:2e:2a , -40
1755814738835 , 60:84:bd:de:7c:60 , -69
1755814738835 , c8:a6:08:9b:16:24 , -46
1755814738835 , c8:a6:08:5b:15:50 , -72
1755814738835 , c8:a6:08:5b:15:51 , -72
1755814738835 , c0:25:a2:a7:2e:27 , -67
1755814738835 , c0:25:a2:a7:2e:26 , -59
1755814738835 , c0:25:a2:a9:b1:4f , -64
1755814738835 , c8:a6:08:5a:fd:04 , -92
1755814738835 , c8:a6:08:9b:15:51 , -75
1755814738835 , c8:a6:08:9b:15:50 , -75
1755814738835 , 84:af:ec:86:f0:60 , -69
1755814738835 , c8:a6:08:9b:16:21 , -46
1755814738835 , c8:a6:08:5b:16:21 , -50
1755814738835 , c8:a6:08:9b:16:20 , -45
1755814738835 , c8:a6:08:5b:16:20 , -50
1755814738835 , c8:a6:08:5a:fd:01 , -91
1755814738835 , c8:a6:08:9b:15:54 , -75
1755814738835 , f8:b7:97:9b:d6:fe , -84
1755814738835 , c8:a6:08:9a:bb:f4 , -84
1755814738835 , c8:a6:08:5a:bb:f4 , -83
1755814738835 , c8:a6:08:5a:bb:f1 , -83
1755814738835 , c8:a6:08:9a:bb:f0 , -84
1755814738835 , c4:36:c0:e3:cc:3e , -76
1755814738835 , c8:a6:08:9a:bb:f1 , -84
1755814739850 , 74:03:bd:ef:8a:00 , -76
1755814739850 , c8:a6:08:9a:fe:71 , -76
1755814739850 , c8:a6:08:9a:fc:90 , -94
1755814739850 , c8:a6:08:9a:fe:70 , -76
1755814739850 , c8:a6:08:9a:fc:91 , -94
1755814739850 , c4:36:c0:e3:cc:30 , -67
1755814739850 , c8:a6:08:9a:fc:94 , -95
1755814739850 , c8:a6:08:9a:fe:74 , -76
1755814739850 , 84:af:ec:86:f0:70 , -79
1755814739850 , c4:36:c0:e3:cc:36 , -67
1755814739850 , ac:44:f2:8c:e8:a8 , -80
1755814739850 , c4:36:c0:e3:cc:37 , -69
1755814739850 , c8:a6:08:9a:bb:c4 , -67
1755814739850 , c4:36:c0:e3:cc:38 , -78
1755814739850 , c8:a6:08:9a:bb:c1 , -67
1755814739850 , c8:a6:08:5a:fe:71 , -76
1755814739850 , c8:a6:08:5a:fe:70 , -76
1755814739850 , c8:a6:08:5a:bb:c1 , -66
1755814739850 , e8:4f:25:d3:9b:75 , -41
1755814739850 , c8:a6:08:9a:bb:c0 , -67
1755814739850 , c8:a6:08:5a:bb:c0 , -38
1755814739850 , c8:a6:08:9b:16:04 , -50
1755814739850 , 74:03:bd:ef:8a:10 , -85
1755814739850 , c8:a6:08:5b:16:04 , -52
1755814739850 , c8:a6:08:9b:16:01 , -50
1755814739850 , c8:a6:08:5b:16:01 , -52
1755814739850 , c8:a6:08:9b:16:00 , -50
1755814739850 , c8:a6:08:5b:16:00 , -52
1755814739850 , 3c:64:cf:5c:de:08 , -75
1755814739850 , c4:36:c0:e3:cc:3f , -77
1755814739850 , c8:a6:08:5a:bb:81 , -70
1755814739850 , c8:a6:08:9a:bc:10 , -61
1755814739850 , c8:a6:08:5a:bb:80 , -71
1755814739850 , c8:a6:08:9a:bc:11 , -61
1755814739850 , c8:a6:08:9a:bc:14 , -61
1755814739850 , c8:a6:08:9a:bb:80 , -75
1755814739850 , c8:a6:08:5a:bc:11 , -62
1755814739850 , c8:a6:08:9a:bb:81 , -75
1755814739850 , c8:a6:08:5a:bc:10 , -63
1755814739850 , ac:44:f2:8c:b0:e0 , -80
1755814739850 , c8:a6:08:9a:bb:84 , -75
1755814739850 , 60:84:bd:de:7c:67 , -74
1755814739850 , ac:44:f2:8c:e9:20 , -78
1755814739850 , c8:a6:08:5a:bb:84 , -71
1755814739850 , c0:25:a2:a7:2e:2b , -67
1755814739850 , c0:25:a2:a7:2e:2a , -40
1755814739850 , 60:84:bd:de:7c:60 , -69
1755814739850 , c8:a6:08:9b:16:24 , -46
1755814739850 , c8:a6:08:5b:15:50 , -72
1755814739850 , c8:a6:08:5b:15:51 , -72
1755814739850 , c0:25:a2:a7:2e:27 , -67
1755814739850 , c0:25:a2:a7:2e:26 , -59
1755814739850 , c0:25:a2:a9:b1:4f , -64
1755814739850 , c8:a6:08:5a:fd:04 , -92
1755814739850 , c8:a6:08:9b:15:51 , -75
1755814739850 , c8:a6:08:9b:15:50 , -75
1755814739850 , 84:af:ec:86:f0:60 , -69
1755814739850 , c8:a6:08:9b:16:21 , -46
1755814739850 , c8:a6:08:5b:16:21 , -50
1755814739850 , c8:a6:08:9b:16:20 , -45
1755814739850 , c8:a6:08:5b:16:20 , -50
1755814739850 , c8:a6:08:5a:fd:01 , -91
1755814739850 , c8:a6:08:9b:15:54 , -75
1755814739850 , f8:b7:97:9b:d6:fe , -84
1755814739850 , c8:a6:08:9a:bb:f4 , -84
1755814739850 , c8:a6:08:5a:bb:f4 , -83
1755814739850 , c8:a6:08:5a:bb:f1 , -83
1755814739850 , c8:a6:08:9a:bb:f0 , -84
1755814739850 , c4:36:c0:e3:cc:3e , -76
1755814739850 , c8:a6:08:9a:bb:f1 , -84
1755814740864 , 74:03:bd:ef:8a:00 , -76
1755814740864 , c8:a6:08:9a:fe:71 , -76
1755814740864 , c8:a6:08:9a:fc:90 , -94
1755814740864 , c8:a6:08:9a:fe:70 , -76
1755814740864 , c8:a6:08:9a:fc:91 , -94
1755814740864 , c4:36:c0:e3:cc:30 , -67
1755814740864 , c8:a6:08:9a:fc:94 , -95
1755814740864 , c8:a6:08:9a:fe:74 , -76
1755814740864 , 84:af:ec:86:f0:70 , -79
1755814740864 , c4:36:c0:e3:cc:36 , -67
1755814740864 , ac:44:f2:8c:e8:a8 , -80
1755814740864 , c4:36:c0:e3:cc:37 , -69
1755814740864 , c8:a6:08:9a:bb:c4 , -67
1755814740864 , c4:36:c0:e3:cc:38 , -78
1755814740864 , c8:a6:08:9a:bb:c1 , -67
1755814740864 , c8:a6:08:5a:fe:71 , -76
1755814740864 , c8:a6:08:5a:fe:70 , -76
1755814740864 , c8:a6:08:5a:bb:c1 , -66
1755814740864 , e8:4f:25:d3:9b:75 , -41
1755814740864 , c8:a6:08:9a:bb:c0 , -67
1755814740864 , c8:a6:08:5a:bb:c0 , -38
1755814740864 , c8:a6:08:9b:16:04 , -50
1755814740864 , 74:03:bd:ef:8a:10 , -85
1755814740864 , c8:a6:08:5b:16:04 , -52
1755814740864 , c8:a6:08:9b:16:01 , -50
1755814740864 , c8:a6:08:5b:16:01 , -52
1755814740864 , c8:a6:08:9b:16:00 , -50
1755814740864 , c8:a6:08:5b:16:00 , -52
1755814740864 , 3c:64:cf:5c:de:08 , -75
1755814740864 , c4:36:c0:e3:cc:3f , -77
1755814740864 , c8:a6:08:5a:bb:81 , -70
1755814740864 , c8:a6:08:9a:bc:10 , -61
1755814740864 , c8:a6:08:5a:bb:80 , -71
1755814740864 , c8:a6:08:9a:bc:11 , -61
1755814740864 , c8:a6:08:9a:bc:14 , -61
1755814740864 , c8:a6:08:9a:bb:80 , -75
1755814740864 , c8:a6:08:5a:bc:11 , -62
1755814740864 , c8:a6:08:9a:bb:81 , -75
1755814740864 , c8:a6:08:5a:bc:10 , -63
1755814740864 , ac:44:f2:8c:b0:e0 , -80
1755814740864 , c8:a6:08:9a:bb:84 , -75
1755814740864 , 60:84:bd:de:7c:67 , -74
1755814740864 , ac:44:f2:8c:e9:20 , -78
1755814740864 , c8:a6:08:5a:bb:84 , -71
1755814740864 , c0:25:a2:a7:2e:2b , -67
1755814740864 , c0:25:a2:a7:2e:2a , -40
1755814740864 , 60:84:bd:de:7c:60 , -69
1755814740864 , c8:a6:08:9b:16:24 , -46
1755814740864 , c8:a6:08:5b:15:50 , -72
1755814740864 , c8:a6:08:5b:15:51 , -72
1755814740864 , c0:25:a2:a7:2e:27 , -67
1755814740864 , c0:25:a2:a7:2e:26 , -59
1755814740864 , c0:25:a2:a9:b1:4f , -64
1755814740864 , c8:a6:08:5a:fd:04 , -92
1755814740864 , c8:a6:08:9b:15:51 , -75
1755814740864 , c8:a6:08:9b:15:50 , -75
1755814740864 , 84:af:ec:86:f0:60 , -69
1755814740864 , c8:a6:08:9b:16:21 , -46
1755814740864 , c8:a6:08:5b:16:21 , -50
1755814740864 , c8:a6:08:9b:16:20 , -45
1755814740864 , c8:a6:08:5b:16:20 , -50
1755814740864 , c8:a6:08:5a:fd:01 , -91
1755814740864 , c8:a6:08:9b:15:54 , -75
1755814740864 , f8:b7:97:9b:d6:fe , -84
1755814740864 , c8:a6:08:9a:bb:f4 , -84
1755814740864 , c8:a6:08:5a:bb:f4 , -83
1755814740864 , c8:a6:08:5a:bb:f1 , -83
1755814740864 , c8:a6:08:9a:bb:f0 , -84
1755814740864 , c4:36:c0:e3:cc:3e , -76
1755814740864 , c8:a6:08:9a:bb:f1 , -84
1755814741866 , 74:03:bd:ef:8a:00 , -76
1755814741866 , c8:a6:08:9a:fe:71 , -76
1755814741866 , c8:a6:08:9a:fc:90 , -94
1755814741866 , c8:a6:08:9a:fe:70 , -76
1755814741866 , c8:a6:08:9a:fc:91 , -94
1755814741866 , c4:36:c0:e3:cc:30 , -67
1755814741866 , c8:a6:08:9a:fc:94 , -95
1755814741866 , c8:a6:08:9a:fe:74 , -76
1755814741866 , 84:af:ec:86:f0:70 , -79
1755814741866 , c4:36:c0:e3:cc:36 , -67
1755814741866 , ac:44:f2:8c:e8:a8 , -80
1755814741866 , c4:36:c0:e3:cc:37 , -69
1755814741866 , c8:a6:08:9a:bb:c4 , -67
1755814741866 , c4:36:c0:e3:cc:38 , -78
1755814741866 , c8:a6:08:9a:bb:c1 , -67
1755814741866 , c8:a6:08:5a:fe:71 , -76
1755814741866 , c8:a6:08:5a:fe:70 , -76
1755814741866 , c8:a6:08:5a:bb:c1 , -66
1755814741866 , e8:4f:25:d3:9b:75 , -41
1755814741866 , c8:a6:08:9a:bb:c0 , -67
1755814741866 , c8:a6:08:5a:bb:c0 , -38
1755814741866 , c8:a6:08:9b:16:04 , -50
1755814741866 , 74:03:bd:ef:8a:10 , -85
1755814741866 , c8:a6:08:5b:16:04 , -52
1755814741866 , c8:a6:08:9b:16:01 , -50
1755814741866 , c8:a6:08:5b:16:01 , -52
1755814741866 , c8:a6:08:9b:16:00 , -50
1755814741866 , c8:a6:08:5b:16:00 , -52
1755814741866 , 3c:64:cf:5c:de:08 , -75
1755814741866 , c4:36:c0:e3:cc:3f , -77
1755814741866 , c8:a6:08:5a:bb:81 , -70
1755814741866 , c8:a6:08:9a:bc:10 , -61
1755814741866 , c8:a6:08:5a:bb:80 , -71
1755814741866 , c8:a6:08:9a:bc:11 , -61
1755814741866 , c8:a6:08:9a:bc:14 , -61
1755814741866 , c8:a6:08:9a:bb:80 , -75
1755814741866 , c8:a6:08:5a:bc:11 , -62
1755814741866 , c8:a6:08:9a:bb:81 , -75
1755814741866 , c8:a6:08:5a:bc:10 , -63
1755814741866 , ac:44:f2:8c:b0:e0 , -80
1755814741866 , c8:a6:08:9a:bb:84 , -75
1755814741866 , 60:84:bd:de:7c:67 , -74
1755814741866 , ac:44:f2:8c:e9:20 , -78
1755814741866 , c8:a6:08:5a:bb:84 , -71
1755814741866 , c0:25:a2:a7:2e:2b , -67
1755814741866 , c0:25:a2:a7:2e:2a , -40
1755814741866 , 60:84:bd:de:7c:60 , -69
1755814741866 , c8:a6:08:9b:16:24 , -46
1755814741866 , c8:a6:08:5b:15:50 , -72
1755814741866 , c8:a6:08:5b:15:51 , -72
1755814741866 , c0:25:a2:a7:2e:27 , -67
1755814741866 , c0:25:a2:a7:2e:26 , -59
1755814741866 , c0:25:a2:a9:b1:4f , -64
1755814741866 , c8:a6:08:5a:fd:04 , -92
1755814741866 , c8:a6:08:9b:15:51 , -75
1755814741866 , c8:a6:08:9b:15:50 , -75
1755814741866 , 84:af:ec:86:f0:60 , -69
1755814741866 , c8:a6:08:9b:16:21 , -46
1755814741866 , c8:a6:08:5b:16:21 , -50
1755814741866 , c8:a6:08:9b:16:20 , -45
1755814741866 , c8:a6:08:5b:16:20 , -50
1755814741866 , c8:a6:08:5a:fd:01 , -91
1755814741866 , c8:a6:08:9b:15:54 , -75
1755814741866 , f8:b7:97:9b:d6:fe , -84
1755814741866 , c8:a6:08:9a:bb:f4 , -84
1755814741866 , c8:a6:08:5a:bb:f4 , -83
1755814741866 , c8:a6:08:5a:bb:f1 , -83
1755814741866 , c8:a6:08:9a:bb:f0 , -84
1755814741866 , c4:36:c0:e3:cc:3e , -76
1755814741866 , c8:a6:08:9a:bb:f1 , -84
1755814742881 , 74:03:bd:ef:8a:00 , -76
1755814742881 , c8:a6:08:9a:fe:71 , -76
1755814742881 , c8:a6:08:9a:fc:90 , -94
1755814742881 , c8:a6:08:9a:fe:70 , -76
1755814742881 , c8:a6:08:9a:fc:91 , -94
1755814742881 , c4:36:c0:e3:cc:30 , -67
1755814742881 , c8:a6:08:9a:fc:94 , -95
1755814742881 , c8:a6:08:9a:fe:74 , -76
1755814742881 , 84:af:ec:86:f0:70 , -79
1755814742881 , c4:36:c0:e3:cc:36 , -67
1755814742881 , ac:44:f2:8c:e8:a8 , -80
1755814742881 , c4:36:c0:e3:cc:37 , -69
1755814742881 , c8:a6:08:9a:bb:c4 , -67
1755814742881 , c4:36:c0:e3:cc:38 , -78
1755814742881 , c8:a6:08:9a:bb:c1 , -67
1755814742881 , c8:a6:08:5a:fe:71 , -76
1755814742881 , c8:a6:08:5a:fe:70 , -76
1755814742881 , c8:a6:08:5a:bb:c1 , -66
1755814742881 , e8:4f:25:d3:9b:75 , -41
1755814742881 , c8:a6:08:9a:bb:c0 , -67
1755814742881 , c8:a6:08:5a:bb:c0 , -38
1755814742881 , c8:a6:08:9b:16:04 , -50
1755814742881 , 74:03:bd:ef:8a:10 , -85
1755814742881 , c8:a6:08:5b:16:04 , -52
1755814742881 , c8:a6:08:9b:16:01 , -50
1755814742881 , c8:a6:08:5b:16:01 , -52
1755814742881 , c8:a6:08:9b:16:00 , -50
1755814742881 , c8:a6:08:5b:16:00 , -52
1755814742881 , 3c:64:cf:5c:de:08 , -75
1755814742881 , c4:36:c0:e3:cc:3f , -77
1755814742881 , c8:a6:08:5a:bb:81 , -70
1755814742881 , c8:a6:08:9a:bc:10 , -61
1755814742881 , c8:a6:08:5a:bb:80 , -71
1755814742881 , c8:a6:08:9a:bc:11 , -61
1755814742881 , c8:a6:08:9a:bc:14 , -61
1755814742881 , c8:a6:08:9a:bb:80 , -75
1755814742881 , c8:a6:08:5a:bc:11 , -62
1755814742881 , c8:a6:08:9a:bb:81 , -75
1755814742881 , c8:a6:08:5a:bc:10 , -63
1755814742881 , ac:44:f2:8c:b0:e0 , -80
1755814742881 , c8:a6:08:9a:bb:84 , -75
1755814742881 , 60:84:bd:de:7c:67 , -74
1755814742881 , ac:44:f2:8c:e9:20 , -78
1755814742881 , c8:a6:08:5a:bb:84 , -71
1755814742881 , c0:25:a2:a7:2e:2b , -67
1755814742881 , c0:25:a2:a7:2e:2a , -40
1755814742881 , 60:84:bd:de:7c:60 , -69
1755814742881 , c8:a6:08:9b:16:24 , -46
1755814742881 , c8:a6:08:5b:15:50 , -72
1755814742881 , c8:a6:08:5b:15:51 , -72
1755814742881 , c0:25:a2:a7:2e:27 , -67
1755814742881 , c0:25:a2:a7:2e:26 , -59
1755814742881 , c0:25:a2:a9:b1:4f , -64
1755814742881 , c8:a6:08:5a:fd:04 , -92
1755814742881 , c8:a6:08:9b:15:51 , -75
1755814742881 , c8:a6:08:9b:15:50 , -75
1755814742881 , 84:af:ec:86:f0:60 , -69
1755814742881 , c8:a6:08:9b:16:21 , -46
1755814742881 , c8:a6:08:5b:16:21 , -50
1755814742881 , c8:a6:08:9b:16:20 , -45
1755814742881 , c8:a6:08:5b:16:20 , -50
1755814742881 , c8:a6:08:5a:fd:01 , -91
1755814742881 , c8:a6:08:9b:15:54 , -75
1755814742881 , f8:b7:97:9b:d6:fe , -84
1755814742881 , c8:a6:08:9a:bb:f4 , -84
1755814742881 , c8:a6:08:5a:bb:f4 , -83
1755814742881 , c8:a6:08:5a:bb:f1 , -83
1755814742881 , c8:a6:08:9a:bb:f0 , -84
1755814742881 , c4:36:c0:e3:cc:3e , -76
1755814742881 , c8:a6:08:9a:bb:f1 , -84
1755814743894 , 74:03:bd:ef:8a:00 , -76
1755814743894 , c8:a6:08:9a:fe:71 , -76
1755814743894 , c8:a6:08:9a:fc:90 , -94
1755814743894 , c8:a6:08:9a:fe:70 , -76
1755814743894 , c8:a6:08:9a:fc:91 , -94
1755814743894 , c4:36:c0:e3:cc:30 , -67
1755814743894 , c8:a6:08:9a:fc:94 , -95
1755814743894 , c8:a6:08:9a:fe:74 , -76
1755814743894 , 84:af:ec:86:f0:70 , -79
1755814743894 , c4:36:c0:e3:cc:36 , -67
1755814743894 , ac:44:f2:8c:e8:a8 , -80
1755814743894 , c4:36:c0:e3:cc:37 , -69
1755814743894 , c8:a6:08:9a:bb:c4 , -67
1755814743894 , c4:36:c0:e3:cc:38 , -78
1755814743894 , c8:a6:08:9a:bb:c1 , -67
1755814743894 , c8:a6:08:5a:fe:71 , -76
1755814743894 , c8:a6:08:5a:fe:70 , -76
1755814743894 , c8:a6:08:5a:bb:c1 , -66
1755814743894 , e8:4f:25:d3:9b:75 , -41
1755814743894 , c8:a6:08:9a:bb:c0 , -67
1755814743894 , c8:a6:08:5a:bb:c0 , -38
1755814743894 , c8:a6:08:9b:16:04 , -50
1755814743894 , 74:03:bd:ef:8a:10 , -85
1755814743894 , c8:a6:08:5b:16:04 , -52
1755814743894 , c8:a6:08:9b:16:01 , -50
1755814743894 , c8:a6:08:5b:16:01 , -52
1755814743894 , c8:a6:08:9b:16:00 , -50
1755814743894 , c8:a6:08:5b:16:00 , -52
1755814743894 , 3c:64:cf:5c:de:08 , -75
1755814743894 , c4:36:c0:e3:cc:3f , -77
1755814743894 , c8:a6:08:5a:bb:81 , -70
1755814743894 , c8:a6:08:9a:bc:10 , -61
1755814743894 , c8:a6:08:5a:bb:80 , -71
1755814743894 , c8:a6:08:9a:bc:11 , -61
1755814743894 , c8:a6:08:9a:bc:14 , -61
1755814743894 , c8:a6:08:9a:bb:80 , -75
1755814743894 , c8:a6:08:5a:bc:11 , -62
1755814743894 , c8:a6:08:9a:bb:81 , -75
1755814743894 , c8:a6:08:5a:bc:10 , -63
1755814743894 , ac:44:f2:8c:b0:e0 , -80
1755814743894 , c8:a6:08:9a:bb:84 , -75
1755814743894 , 60:84:bd:de:7c:67 , -74
1755814743894 , ac:44:f2:8c:e9:20 , -78
1755814743894 , c8:a6:08:5a:bb:84 , -71
1755814743894 , c0:25:a2:a7:2e:2b , -67
1755814743894 , c0:25:a2:a7:2e:2a , -40
1755814743894 , 60:84:bd:de:7c:60 , -69
1755814743894 , c8:a6:08:9b:16:24 , -46
1755814743894 , c8:a6:08:5b:15:50 , -72
1755814743894 , c8:a6:08:5b:15:51 , -72
1755814743894 , c0:25:a2:a7:2e:27 , -67
1755814743894 , c0:25:a2:a7:2e:26 , -59
1755814743894 , c0:25:a2:a9:b1:4f , -64
1755814743894 , c8:a6:08:5a:fd:04 , -92
1755814743894 , c8:a6:08:9b:15:51 , -75
1755814743894 , c8:a6:08:9b:15:50 , -75
1755814743894 , 84:af:ec:86:f0:60 , -69
1755814743894 , c8:a6:08:9b:16:21 , -46
1755814743894 , c8:a6:08:5b:16:21 , -50
1755814743894 , c8:a6:08:9b:16:20 , -45
1755814743894 , c8:a6:08:5b:16:20 , -50
1755814743894 , c8:a6:08:5a:fd:01 , -91
1755814743894 , c8:a6:08:9b:15:54 , -75
1755814743894 , f8:b7:97:9b:d6:fe , -84
1755814743894 , c8:a6:08:9a:bb:f4 , -84
1755814743894 , c8:a6:08:5a:bb:f4 , -83
1755814743894 , c8:a6:08:5a:bb:f1 , -83
1755814743894 , c8:a6:08:9a:bb:f0 , -84
1755814743894 , c4:36:c0:e3:cc:3e , -76
1755814743894 , c8:a6:08:9a:bb:f1 , -84
1755814744904 , 74:03:bd:ef:8a:00 , -76
1755814744904 , c8:a6:08:9a:fe:71 , -76
1755814744904 , c8:a6:08:9a:fc:90 , -94
1755814744904 , c8:a6:08:9a:fe:70 , -76
1755814744904 , c8:a6:08:9a:fc:91 , -94
1755814744904 , c4:36:c0:e3:cc:30 , -67
1755814744904 , c8:a6:08:9a:fc:94 , -95
1755814744904 , c8:a6:08:9a:fe:74 , -76
1755814744904 , 84:af:ec:86:f0:70 , -79
1755814744904 , c4:36:c0:e3:cc:36 , -67
1755814744904 , ac:44:f2:8c:e8:a8 , -80
1755814744904 , c4:36:c0:e3:cc:37 , -69
1755814744904 , c8:a6:08:9a:bb:c4 , -67
1755814744904 , c4:36:c0:e3:cc:38 , -78
1755814744904 , c8:a6:08:9a:bb:c1 , -67
1755814744904 , c8:a6:08:5a:fe:71 , -76
1755814744904 , c8:a6:08:5a:fe:70 , -76
1755814744904 , c8:a6:08:5a:bb:c1 , -66
1755814744904 , e8:4f:25:d3:9b:75 , -41
1755814744904 , c8:a6:08:9a:bb:c0 , -67
1755814744904 , c8:a6:08:5a:bb:c0 , -38
1755814744904 , c8:a6:08:9b:16:04 , -50
1755814744904 , 74:03:bd:ef:8a:10 , -85
1755814744904 , c8:a6:08:5b:16:04 , -52
1755814744904 , c8:a6:08:9b:16:01 , -50
1755814744904 , c8:a6:08:5b:16:01 , -52
1755814744904 , c8:a6:08:9b:16:00 , -50
1755814744904 , c8:a6:08:5b:16:00 , -52
1755814744904 , 3c:64:cf:5c:de:08 , -75
1755814744904 , c4:36:c0:e3:cc:3f , -77
1755814744904 , c8:a6:08:5a:bb:81 , -70
1755814744904 , c8:a6:08:9a:bc:10 , -61
1755814744904 , c8:a6:08:5a:bb:80 , -71
1755814744904 , c8:a6:08:9a:bc:11 , -61
1755814744904 , c8:a6:08:9a:bc:14 , -61
1755814744904 , c8:a6:08:9a:bb:80 , -75
1755814744904 , c8:a6:08:5a:bc:11 , -62
1755814744904 , c8:a6:08:9a:bb:81 , -75
1755814744904 , c8:a6:08:5a:bc:10 , -63
1755814744904 , ac:44:f2:8c:b0:e0 , -80
1755814744904 , c8:a6:08:9a:bb:84 , -75
1755814744904 , 60:84:bd:de:7c:67 , -74
1755814744904 , ac:44:f2:8c:e9:20 , -78
1755814744904 , c8:a6:08:5a:bb:84 , -71
1755814744904 , c0:25:a2:a7:2e:2b , -67
1755814744904 , c0:25:a2:a7:2e:2a , -40
1755814744904 , 60:84:bd:de:7c:60 , -69
1755814744904 , c8:a6:08:9b:16:24 , -46
1755814744904 , c8:a6:08:5b:15:50 , -72
1755814744904 , c8:a6:08:5b:15:51 , -72
1755814744904 , c0:25:a2:a7:2e:27 , -67
1755814744904 , c0:25:a2:a7:2e:26 , -59
1755814744904 , c0:25:a2:a9:b1:4f , -64
1755814744904 , c8:a6:08:5a:fd:04 , -92
1755814744904 , c8:a6:08:9b:15:51 , -75
1755814744904 , c8:a6:08:9b:15:50 , -75
1755814744904 , 84:af:ec:86:f0:60 , -69
1755814744904 , c8:a6:08:9b:16:21 , -46
1755814744904 , c8:a6:08:5b:16:21 , -50
1755814744904 , c8:a6:08:9b:16:20 , -45
1755814744904 , c8:a6:08:5b:16:20 , -50
1755814744904 , c8:a6:08:5a:fd:01 , -91
1755814744904 , c8:a6:08:9b:15:54 , -75
1755814744904 , f8:b7:97:9b:d6:fe , -84
1755814744904 , c8:a6:08:9a:bb:f4 , -84
1755814744904 , c8:a6:08:5a:bb:f4 , -83
1755814744904 , c8:a6:08:5a:bb:f1 , -83
1755814744904 , c8:a6:08:9a:bb:f0 , -84
1755814744904 , c4:36:c0:e3:cc:3e , -76
1755814744904 , c8:a6:08:9a:bb:f1 , -84
1755814745927 , 74:03:bd:ef:8a:00 , -76
1755814745927 , c8:a6:08:9a:fe:71 , -76
1755814745927 , c8:a6:08:9a:fc:90 , -94
1755814745927 , c8:a6:08:9a:fe:70 , -76
1755814745927 , c8:a6:08:9a:fc:91 , -94
1755814745927 , c4:36:c0:e3:cc:30 , -67
1755814745927 , c8:a6:08:9a:fc:94 , -95
1755814745927 , c8:a6:08:9a:fe:74 , -76
1755814745927 , 84:af:ec:86:f0:70 , -79
1755814745927 , c4:36:c0:e3:cc:36 , -67
1755814745927 , ac:44:f2:8c:e8:a8 , -80
1755814745927 , c4:36:c0:e3:cc:37 , -69
1755814745927 , c8:a6:08:9a:bb:c4 , -67
1755814745927 , c4:36:c0:e3:cc:38 , -78
1755814745927 , c8:a6:08:9a:bb:c1 , -67
1755814745927 , c8:a6:08:5a:fe:71 , -76
1755814745927 , c8:a6:08:5a:fe:70 , -76
1755814745927 , c8:a6:08:5a:bb:c1 , -66
1755814745927 , e8:4f:25:d3:9b:75 , -41
1755814745927 , c8:a6:08:9a:bb:c0 , -67
1755814745927 , c8:a6:08:5a:bb:c0 , -38
1755814745927 , c8:a6:08:9b:16:04 , -50
1755814745927 , 74:03:bd:ef:8a:10 , -85
1755814745927 , c8:a6:08:5b:16:04 , -52
1755814745927 , c8:a6:08:9b:16:01 , -50
1755814745927 , c8:a6:08:5b:16:01 , -52
1755814745927 , c8:a6:08:9b:16:00 , -50
1755814745927 , c8:a6:08:5b:16:00 , -52
1755814745927 , 3c:64:cf:5c:de:08 , -75
1755814745927 , c4:36:c0:e3:cc:3f , -77
1755814745927 , c8:a6:08:5a:bb:81 , -70
1755814745927 , c8:a6:08:9a:bc:10 , -61
1755814745927 , c8:a6:08:5a:bb:80 , -71
1755814745927 , c8:a6:08:9a:bc:11 , -61
1755814745927 , c8:a6:08:9a:bc:14 , -61
1755814745927 , c8:a6:08:9a:bb:80 , -75
1755814745927 , c8:a6:08:5a:bc:11 , -62
1755814745927 , c8:a6:08:9a:bb:81 , -75
1755814745927 , c8:a6:08:5a:bc:10 , -63
1755814745927 , ac:44:f2:8c:b0:e0 , -80
1755814745927 , c8:a6:08:9a:bb:84 , -75
1755814745927 , 60:84:bd:de:7c:67 , -74
1755814745927 , ac:44:f2:8c:e9:20 , -78
1755814745927 , c8:a6:08:5a:bb:84 , -71
1755814745927 , c0:25:a2:a7:2e:2b , -67
1755814745927 , c0:25:a2:a7:2e:2a , -40
1755814745927 , 60:84:bd:de:7c:60 , -69
1755814745927 , c8:a6:08:9b:16:24 , -46
1755814745927 , c8:a6:08:5b:15:50 , -72
1755814745927 , c8:a6:08:5b:15:51 , -72
1755814745927 , c0:25:a2:a7:2e:27 , -67
1755814745927 , c0:25:a2:a7:2e:26 , -59
1755814745927 , c0:25:a2:a9:b1:4f , -64
1755814745927 , c8:a6:08:5a:fd:04 , -92
1755814745927 , c8:a6:08:9b:15:51 , -75
1755814745927 , c8:a6:08:9b:15:50 , -75
1755814745927 , 84:af:ec:86:f0:60 , -69
1755814745927 , c8:a6:08:9b:16:21 , -46
1755814745927 , c8:a6:08:5b:16:21 , -50
1755814745927 , c8:a6:08:9b:16:20 , -45
1755814745927 , c8:a6:08:5b:16:20 , -50
1755814745927 , c8:a6:08:5a:fd:01 , -91
1755814745927 , c8:a6:08:9b:15:54 , -75
1755814745927 , f8:b7:97:9b:d6:fe , -84
1755814745927 , c8:a6:08:9a:bb:f4 , -84
1755814745927 , c8:a6:08:5a:bb:f4 , -83
1755814745927 , c8:a6:08:5a:bb:f1 , -83
1755814745927 , c8:a6:08:9a:bb:f0 , -84
1755814745927 , c4:36:c0:e3:cc:3e , -76
1755814745927 , c8:a6:08:9a:bb:f1 , -84
1755814746940 , 74:03:bd:ef:8a:00 , -76
1755814746940 , c8:a6:08:9a:fe:71 , -76
1755814746940 , c8:a6:08:9a:fc:90 , -94
1755814746940 , c8:a6:08:9a:fe:70 , -76
1755814746940 , c8:a6:08:9a:fc:91 , -94
1755814746940 , c4:36:c0:e3:cc:30 , -67
1755814746940 , c8:a6:08:9a:fc:94 , -95
1755814746940 , c8:a6:08:9a:fe:74 , -76
1755814746940 , 84:af:ec:86:f0:70 , -79
1755814746940 , c4:36:c0:e3:cc:36 , -67
1755814746940 , ac:44:f2:8c:e8:a8 , -80
1755814746940 , c4:36:c0:e3:cc:37 , -69
1755814746940 , c8:a6:08:9a:bb:c4 , -67
1755814746940 , c4:36:c0:e3:cc:38 , -78
1755814746940 , c8:a6:08:9a:bb:c1 , -67
1755814746940 , c8:a6:08:5a:fe:71 , -76
1755814746940 , c8:a6:08:5a:fe:70 , -76
1755814746940 , c8:a6:08:5a:bb:c1 , -66
1755814746940 , e8:4f:25:d3:9b:75 , -41
1755814746940 , c8:a6:08:9a:bb:c0 , -67
1755814746940 , c8:a6:08:5a:bb:c0 , -38
1755814746940 , c8:a6:08:9b:16:04 , -50
1755814746940 , 74:03:bd:ef:8a:10 , -85
1755814746940 , c8:a6:08:5b:16:04 , -52
1755814746940 , c8:a6:08:9b:16:01 , -50
1755814746940 , c8:a6:08:5b:16:01 , -52
1755814746940 , c8:a6:08:9b:16:00 , -50
1755814746940 , c8:a6:08:5b:16:00 , -52
1755814746940 , 3c:64:cf:5c:de:08 , -75
1755814746940 , c4:36:c0:e3:cc:3f , -77
1755814746940 , c8:a6:08:5a:bb:81 , -70
1755814746940 , c8:a6:08:9a:bc:10 , -61
1755814746940 , c8:a6:08:5a:bb:80 , -71
1755814746940 , c8:a6:08:9a:bc:11 , -61
1755814746940 , c8:a6:08:9a:bc:14 , -61
1755814746940 , c8:a6:08:9a:bb:80 , -75
1755814746940 , c8:a6:08:5a:bc:11 , -62
1755814746940 , c8:a6:08:9a:bb:81 , -75
1755814746940 , c8:a6:08:5a:bc:10 , -63
1755814746940 , ac:44:f2:8c:b0:e0 , -80
1755814746940 , c8:a6:08:9a:bb:84 , -75
1755814746940 , 60:84:bd:de:7c:67 , -74
1755814746940 , ac:44:f2:8c:e9:20 , -78
1755814746940 , c8:a6:08:5a:bb:84 , -71
1755814746940 , c0:25:a2:a7:2e:2b , -67
1755814746940 , c0:25:a2:a7:2e:2a , -40
1755814746940 , 60:84:bd:de:7c:60 , -69
1755814746940 , c8:a6:08:9b:16:24 , -46
1755814746940 , c8:a6:08:5b:15:50 , -72
1755814746940 , c8:a6:08:5b:15:51 , -72
1755814746940 , c0:25:a2:a7:2e:27 , -67
1755814746940 , c0:25:a2:a7:2e:26 , -59
1755814746940 , c0:25:a2:a9:b1:4f , -64
1755814746940 , c8:a6:08:5a:fd:04 , -92
1755814746940 , c8:a6:08:9b:15:51 , -75
1755814746940 , c8:a6:08:9b:15:50 , -75
1755814746940 , 84:af:ec:86:f0:60 , -69
1755814746940 , c8:a6:08:9b:16:21 , -46
1755814746940 , c8:a6:08:5b:16:21 , -50
1755814746940 , c8:a6:08:9b:16:20 , -45
1755814746940 , c8:a6:08:5b:16:20 , -50
1755814746940 , c8:a6:08:5a:fd:01 , -91
1755814746940 , c8:a6:08:9b:15:54 , -75
1755814746940 , f8:b7:97:9b:d6:fe , -84
1755814746940 , c8:a6:08:9a:bb:f4 , -84
1755814746940 , c8:a6:08:5a:bb:f4 , -83
1755814746940 , c8:a6:08:5a:bb:f1 , -83
1755814746940 , c8:a6:08:9a:bb:f0 , -84
1755814746940 , c4:36:c0:e3:cc:3e , -76
1755814746940 , c8:a6:08:9a:bb:f1 , -84

EOF

cat >"$ble_csv" <<EOF
1755814739626 , FDA50693-A4E2-4FB1-AFCF-C6EB07647825 , -76
1755814741165 , D546DF97-4757-47EF-BE09-3E2DCBDD0C77 , -78
1755814743534 , 722EB21F-8F6A-4BA9-A12F-05C0F970A177 , -81
1755814745083 , FDA50693-A4E2-4FB1-AFCF-C6EB07647825 , -82

EOF

register_org() {
  local uri="$1"
  local room="$2"
  local port="$3"
  local body
  body=$(cat <<JSON
{"system_uri":"$uri","roomID":"$room","port":$port}
JSON
)
  echo "== register $uri (room $room, port $port) -> $PROXY_BASE/api/service/register"
  pretty_json "$(curl -fsS -X POST "$PROXY_BASE/api/service/register" \
    -H "Content-Type: application/json" \
    --data-binary "${body}")"
}

case "${REGISTER_SET}" in
  manager)
    register_org "$MANAGER_URI" "$MANAGER_ROOM" "$MANAGER_PORT"
    ;;
  manager+echo)
    register_org "$MANAGER_URI" "$MANAGER_ROOM" "$MANAGER_PORT"
    register_org "$ECHO_URI" "$ECHO_ROOM" "$ECHO_PORT"
    ;;
  manager+echo+bravo)
    register_org "$MANAGER_URI" "$MANAGER_ROOM" "$MANAGER_PORT"
    register_org "$ECHO_URI" "$ECHO_ROOM" "$ECHO_PORT"
    register_org "$BRAVO_URI" "$BRAVO_ROOM" "$BRAVO_PORT"
    ;;
  *)
    echo "REGISTER_SET の値が不正です: ${REGISTER_SET}" >&2
    exit 1
    ;;
esac

echo "== federated inquiry (proxy) -> $PROXY_BASE/api/service/inquiry"
inq_proxy_resp=$(curl -fsS -X POST "$PROXY_BASE/api/service/inquiry" \
  -F wifi_data=@"$wifi_csv" \
  -F ble_data=@"$ble_csv")
pretty_json "${inq_proxy_resp}"

echo "== federated inquiry via service forwarder -> $SERVICE_BASE/api/proxy/inquiry"
inq_service_resp=$(curl -fsS -X POST "$SERVICE_BASE/api/proxy/inquiry" \
  -u "${BASIC_AUTH_USER}:${BASIC_AUTH_PASS}" \
  -F wifi_data=@"$wifi_csv" \
  -F ble_data=@"$ble_csv")
pretty_json "${inq_service_resp}"
